"use strict";(self.webpackChunksystem=self.webpackChunksystem||[]).push([[9602],{51078:function(e,a,l){l.r(a),l.d(a,{default:function(){return B}}),l(57658);var t=l(73396),o=l(44870),i=l(87139),s=l(81081),d=l(88490),n=l(10100),c=l(12862);a=l(20566);l(68521);class r extends a.Z{constructor({modules:e="",selectUri:a="/",deleteUri:l="/",selectOneUri:t="/",pageSize:o=20,tableHeader:i}={}){super({modules:e,selectUri:a,deleteUri:l,selectOneUri:t,pageSize:o,tableHeader:i})}async initTableHeader(e=this){var{data:a,code:l}=(await s.K.post(`${e.selectUri}?currentPage=${e.currentPage}&pageSize=1`,e.searchData))["data"];if(200===l&&a)return e.tableHeader=[{title:"批次号",dataKey:"batchCode",key:"batchCode",width:300,type:"text",isShow:!0,isFixed:!1},{title:"状态",dataKey:"status",key:"status",width:300,type:"text",isShow:!0,isFixed:!1},{title:"所属经销商",dataKey:"belongArchiveName",key:"belongArchiveName",width:300,type:"text",isShow:!0,isFixed:!1},{title:"账单编码",dataKey:"billCode",key:"billCode",width:300,type:"text",isShow:!0,isFixed:!1},{title:"账单类型",dataKey:"billType",key:"billType",width:300,type:"text",isShow:!0,isFixed:!1},{title:"账期",dataKey:"costTerm",key:"costTerm",width:300,type:"text",isShow:!0,isFixed:!1}],l=a.resultNameList.map((e=>({title:e.resultName,dataKey:e.resultCode,key:e.resultCode,dataType:e.resultType,decimal:e.decimal,width:300,type:"text",isShow:!0,isFixed:!1}))),e.tableHeader.push(...l),e.tableHeader}async initData(e=this,a){var{data:l,code:t}=(await s.K.post(`${e.selectUri}?currentPage=${e.currentPage}&pageSize=`+e.pageSize,e.searchData))["data"];200===t&&l&&(e.total=l.resultDataList.total,e.tableData.length=0,e.tableData.push(...l.resultDataList.list.map((e=>(e={...e,...e.data},delete e.data,e)))))}currentPageChange(e,a=this,l){a.currentPage=e,a.initData(a,l)}pageSizeChange(e,a=this,l){a.currentPage=1,a.pageSize=e,a.initData(a,l)}search(e,a=this,l){a.searchData=e,a.currentPage=1,a.initData(a,l,!0)}async updateBill(e){var{code:e,data:a,msg:l}=(await s.K.post("/colorful-fog/CollectResultMain/manualUpdate",e))["data"];return 200===e?{data:a,code:e}:l}async checkUpdateData(e){var{code:e,data:a,msg:l}=(await s.K.post("/colorful-fog/UpdateBillLog/selectOneFieldLog",e))["data"];return 200===e?{data:a,code:e}:l}async getCollectExportData(e){var{code:e,data:a,msg:l}=(await s.K.post("/colorful-fog/CollectResultMain/exportExcel",e))["data"];return 200===e?{data:a,code:e}:l}async updateBillFlash(e){var{code:e,data:a,msg:l}=(await s.K.post("/colorful-fog/schemeMain/flash",e))["data"];return 200===e?{data:a,code:e}:l}async setInValid(e){var{code:e,data:a,msg:l}=(await s.K.post("/colorful-fog/billResult/setInValid",e))["data"];return 200===e?{data:a,code:e}:l}}var u=l(82261),h=l(22483);a=e=>((0,t.dD)("data-v-d851f518"),e=e(),(0,t.Cn)(),e);const p={class:"data-filter"},b={class:"extend-handle"},g={class:"extend-handle-left"},m={class:"ml10"},y={style:{padding:"0 10px 10px 10px",background:"#fff"}},v={class:"jx-dialog-header"},w=["id"],f=[a((()=>(0,t._)("h4",{class:"inline-block"}," 账单字段更新日志 ",-1)))],S=a((()=>(0,t._)("div",{class:"mt10 mb10"},[(0,t._)("span",{class:"table-label",style:{"font-weight":"800"}},"更新前"),(0,t._)("span",{class:"table-label",style:{"font-weight":"800"}},"更新后"),(0,t._)("span",{class:"table-label",style:{"font-weight":"800"}},"操作时间"),(0,t._)("span",{class:"table-label",style:{"font-weight":"800"}},"操作人")],-1))),k={class:"update-list"},C=["title"],D=["title"],x={class:"table-label"},_={class:"table-label"},U={class:"jx-dialog-header"},T=["id"],H=[a((()=>(0,t._)("h4",{class:"inline-block"},[(0,t.Uk)(" 更新账单 "),(0,t._)("span",{class:"tips"}," 修改时请勿删除原始数据，直接在旧数据后面拼接上修改的值，用:隔开 【样例：海珠区:天河区】 ")],-1)))],$={style:{display:"flex","align-items":"center"}},V={class:"mt10 footer"};a={__name:"billingdata",setup(e){const a=(0,t.Q2)("authority"),l=(0,h.yj)();(0,h.tv)();const B=(0,o.iH)(""),E=(0,t.FN)()["proxy"];(0,o.iH)(!1);const j=(0,o.iH)(null),N=(0,o.iH)(""),z=(0,o.iH)(""),F=(0,o.iH)(!1),K=((0,t.YP)((()=>l.path),(()=>{"/financial/Detail/billingdata"===l.path&&j.value&&l.query.schemeCode&&(N.value=l.query.schemeCode,z.value=l.query.name,j.value.searchData.schemeCode=N.value,j.value.tableData.length=0,K())})),()=>{j.value.initTableHeader(this).then((e=>{if(e&&0!==e.length){let a=new E.$DataTool;j.value.forMatData=(l,t)=>{var o=e[t.getColumnIndex()-1];return"NULL"!==l[t.property]&&l.hasOwnProperty(t.property)?"DATE"===o.dataType?a.timeStamp2Time(+l[t.property],"yyyy-MM-dd hh:mm:ss"):"NUM"!==o.dataType||Number.isNaN(Number(l[t.property]))?l[t.property]??"-":Number(l[t.property]).toFixed(o.decimal):"-"},j.value.initData(this,E.$refs.table)}}))}),P=((0,t.wF)((()=>{(async()=>{N.value=l.query.schemeCode,z.value=l.query.name,j.value=new r({tableHeader:[],selectUri:"/colorful-fog/billResult/list"}),(N.value?(j.value.searchData={schemeCode:N.value},K):ae)()})()})),e=>{if(0===Object.keys(e).length)return N.value?(e.schemeCode=N.value,void j.value.search(e,this,E.$refs.table)):void ae();let a={schemeCode:N.value,fieldSelectList:{}};Object.entries(e).forEach((([e,l])=>{["belongArchiveName","billCode","billType","costTerm","status","batchCode","auditStatus"].includes(e)?a[e]=l:a.fieldSelectList[e]=l})),j.value.search(a,this,E.$refs.table)}),I=({rowdata:e})=>[(0,t.h)("div",{class:"table-handel-div"},[(0,t.wy)((0,t.h)(u.ElButton,{class:"hover-animation",onClick:()=>{G(e)},title:"查看修改日志",style:"padding:0;margin:0;background:transparent;width:80px;color:#0c81b1;margin-right:10px"},{default:()=>"修改日志"}),[[a,"billingdata:checkUpdateData"]]),(0,t.wy)((0,t.h)(u.ElButton,{class:"hover-animation",onClick:()=>{W(e)},title:"修改该条账单",style:"padding:0;margin:0;background:transparent;width:80px;color:#0c81b1;margin-right:10px"},{default:()=>"修改账单"}),[[a,"billingdata:checkUpdateData"]]),(0,t.wy)((0,t.h)(u.ElButton,{class:"hover-animation",onClick:()=>{O(e)},title:"更新该批次账单",style:"padding:0;margin:0;background:transparent;width:100px;color:#0c81b1;"},{default:()=>"更新该批次账单"}),[[a,"billingdata:refresh"]])])];let L=(0,o.iH)(null);const W=e=>{L.value=[e],F.value=!0},M=()=>{let e=[];Object.entries(L.value[0]).forEach((([a,l])=>{var t;l&&2===l.toString().split(":").length&&(t=j.value.tableHeader.find((e=>e.key===a)),e.push({billType:"BILL",billCode:L.value[0].billCode,fieldName:t.title,fieldCode:t.key,updateValue:l.split(":")[1]}))})),E.$alert("是否确认更新账单？","提示",{type:"info",icon:"InfoFilled",confirmButtonText:"确定",callback:a=>{"confirm"===a&&j.value.updateBill(e).then((e=>{200===e.code&&E.$alert(e.data,"提示",{type:"success",icon:"InfoFilled",showCancelButton:!1,callback:async()=>{j.value.tableData.length=0,K(),F.value=!1}})}))}})},O=e=>{E.$alert("是否确认更新当前批次的所有账单？","提示",{type:"info",icon:"InfoFilled",confirmButtonText:"确定",callback:a=>{"confirm"===a&&j.value.updateBillFlash({schemeCode:N.value,batchCode:e.batchCode}).then((e=>{200===e.code&&(E.$message.success("刷新成功"),j.value.tableData.length=0,K())}))}})},R=(0,o.iH)(!1),q=(0,o.qj)([]),A=(0,o.iH)(""),Y=(0,o.qj)([]),Z=e=>{Y.length=0,Q[B.value]&&Y.push(...Q[B.value])};let Q={};const G=e=>{q.length=0,A.value=e.billCode,j.value.checkUpdateData({billCode:A.value}).then((e=>{e.data?(Q=e.data,Y.length=0,j.value.tableHeader.forEach(((e,a)=>{e.title&&Q[e.key]&&(e={label:e.title,value:e.key},q.push(e))})),0!==q.length&&(B.value=q[0].value),Q[B.value]&&Y.push(...Q[B.value]),R.value=!0):E.$message.error("暂无修改记录")}))},J=()=>{var e=[];let a=[],l=[],t=[],o=[];j.value.tableHeader.forEach((e=>{"selection"!==e.key&&"handle"!==e.key&&(a.push(e.title),l.push(e.key),t.push({type:e.dataType,decimal:e.decimal}))})),j.value.selections.forEach((e=>{let a=[];l.forEach(((l,o)=>{"DATE"===t[o].type?a.push((new E.$DataTool).timeStamp2Time(+e[l],"yyyy-MM-dd hh:mm:ss")):"NUM"!==t[o].type||Number.isNaN(Number(e[l]))?"NULL"===e[l]?a.push("-"):a.push(e[l]):a.push({v:Number(e[l]),t:"n",z:"0."+new Array(t[o].decimal??2).fill(0).join("")})})),o.push(a)})),e.push({header:a,data:o,title:"账单数据",style:{}}),e.push({header:["更新说明","样例"],data:[["如果想更新账单数据，在要跟新的数据单元格后面写上需要更新的值，用:隔开","天河区:海珠区"]],style:{},title:"账单更新说明"}),(new E.$DataTool).complexExcel(e,"账单数据")},X=e=>{let a=[],l=Object.keys(e[0]);return e.forEach((e=>{l.forEach((l=>{var t;e[l]&&-1!==e[l].toString().indexOf(":")&&"更新说明"!==l&&(t=j.value.tableHeader.find((e=>e.title===l)).key,a.push({billType:"BILL",billCode:e["账单编码"],fieldName:l,fieldCode:t,updateValue:e[l].split(":")[1]}))}))})),a},ee=async e=>{e=await(new E.$DataTool).xlsx2DataObject(e.raw);let a=X(e);E.$alert("是否确认导入更新账单？","提示",{type:"info",icon:"InfoFilled",confirmButtonText:"确定",callback:e=>{"confirm"===e&&j.value.updateBill(a).then((e=>{200===e.code&&E.$alert(e.data,"提示",{type:"success",icon:"InfoFilled",showCancelButton:!1,callback:async()=>{j.value.tableData.length=0,K()}})}))}})},ae=async()=>{le.searchPlaceholde="输入账单计划名称进行搜索",le.chooseRow=async e=>{e.children||(N.value=e.schemeCode,z.value=e.name,j.value.searchData.schemeCode=e.schemeCode,j.value.tableData.length=0,j.value.tableHeader.length=0,K(),le.isShow=!1)},le.doSearch=e=>{le.dataSource.searchData={},e&&(le.dataSource.searchData.name=e),le.dataSource.initData()},le.dataSource=new r({selectUri:"/colorful-fog/schemeMain/selectMenu",tableHeader:[{label:"账单名称",prop:"name",width:200},{label:"账单code",prop:"schemeCode",width:200},{label:"类型",prop:"billType",width:200}],pageSize:10}),le.dataSource.forMatData=(e,a)=>e[a.property]?"billType"===a.property?"PAY"===e[a.property]?"应付":"应收":e[a.property]??"-":"-",le.dataSource.initData=async(e=le.dataSource)=>{var{data:e,code:a}=(await s.K.post(`${e.selectUri}?currentPage=${e.currentPage}&pageSize=`+e.pageSize,e.searchData))["data"];200===a&&(le.dataSource.tableData.length=0,a=Object.entries(e).reduce(((e,a,l)=>(a={name:a[0],children:a[1],id:l+1,schemeCode:"-"},e.push(a),e)),[]),le.dataSource.tableData.push(...a),le.dataSource.total=le.dataSource.tableData.length)},await le.dataSource.initData(),le.isShow=!0},le=(0,o.qj)({isShow:!1,dataSource:null,searchPlaceholde:"",doSearch:e=>{},chooseRow:e=>{}}),te=()=>{if(0===j.value.selections.length)E.$message.error("请先选择数据");else{let e=j.value.selections.map((e=>e.billCode));E.$alert("是否确认设置无效","提示",{type:"info",icon:"InfoFilled",confirmButtonText:"确定",callback:a=>{"confirm"===a&&j.value.setInValid(e).then((e=>{200===e.code&&(E.$message.success("设置成功"),j.value.tableData.length=0,K())}))}})}},oe=async e=>{e=await(new E.$DataTool).xlsx2DataObject(e.raw);let a=[];Object.keys(e[0]),e.forEach((e=>{a.push(e["账单编码"])})),E.$alert("是否确认设置无效","提示",{type:"info",icon:"InfoFilled",confirmButtonText:"确定",callback:e=>{"confirm"===e&&j.value.setInValid(a).then((e=>{200===e.code&&(E.$message.success("设置成功"),j.value.tableData.length=0,K())}))}})};return(e,a)=>{var l=(0,t.up)("el-upload");const r=(0,t.up)("Edit"),h=(0,t.up)("el-icon"),N=(0,t.up)("el-input"),K=(0,t.up)("el-option"),W=(0,t.up)("el-select");var O=(0,t.up)("el-dialog");const A=(0,t.up)("el-table-column"),Q=(0,t.up)("el-table"),G=(0,t.Q2)("authorityHandle");return(0,t.wg)(),(0,t.iD)("div",null,[(0,t._)("div",p,[(0,t.Wm)(c.Z,{"filter-items":j.value.tableHeader,onSearch:P},null,8,["filter-items"])]),(0,t._)("div",b,[(0,t._)("div",g,[(0,t.wy)(((0,t.wg)(),(0,t.j4)((0,o.SU)(u.ElButton),{class:"handle-btn mr10",color:"#4a78bd",style:{color:"#666"},plain:"",onClick:J},{default:(0,t.w5)((()=>[(0,t.Uk)(" 导出账单 ")])),_:1})),[[G,"billingdata:export"]]),(0,t.wy)(((0,t.wg)(),(0,t.j4)(l,{class:"inline-block mr10",accept:".xlsx, .xls","on-change":ee,"show-file-list":!1,"auto-upload":!1},{default:(0,t.w5)((()=>[(0,t.Wm)((0,o.SU)(u.ElButton),{class:"handle-btn",color:"#4a78bd",style:{color:"#666"},plain:""},{default:(0,t.w5)((()=>[(0,t.Uk)(" 导入Excel更新 ")])),_:1})])),_:1})),[[G,"billingdata:update"]]),(0,t.wy)(((0,t.wg)(),(0,t.j4)(l,{class:"inline-block mr10",accept:".xlsx, .xls","on-change":oe,"show-file-list":!1,"auto-upload":!1},{default:(0,t.w5)((()=>[(0,t.wy)(((0,t.wg)(),(0,t.j4)((0,o.SU)(u.ElButton),{type:"danger",style:{color:"#666"},plain:""},{default:(0,t.w5)((()=>[(0,t.Uk)(" 导入设置无效账单 ")])),_:1})),[[G,"billingdata:update"]])])),_:1})),[[G,"billingdata:update"]]),(0,t.wy)(((0,t.wg)(),(0,t.j4)((0,o.SU)(u.ElButton),{type:"danger",style:{color:"#666"},plain:"",onClick:te},{default:(0,t.w5)((()=>[(0,t.Uk)(" 设为无效账单 ")])),_:1})),[[G,"billingdata:update"]]),(0,t._)("div",m,[(0,t.Uk)(" 当前账单： "),(0,t.Wm)(N,{modelValue:z.value,"onUpdate:modelValue":a[0]||(a[0]=e=>z.value=e),clearable:"",style:{width:"220px"},placeholder:"请选择方案",disabled:!0},{append:(0,t.w5)((()=>[(0,t.Wm)((0,o.SU)(u.ElButton),{onClick:ae},{default:(0,t.w5)((()=>[(0,t.Wm)(h,null,{default:(0,t.w5)((()=>[(0,t.Wm)(r)])),_:1})])),_:1})])),_:1},8,["modelValue"])])])]),(0,t._)("div",y,[(0,t.Wm)(n.Z,{ref:"table","need-selection":"","options-width":340,"need-end-control":"",total:j.value.total,"current-page":j.value.currentPage,"page-size":j.value.pageSize,"table-data":j.value.tableData,"table-header":j.value.tableHeader,loading:(0,o.SU)(s.V)&&!le.isShow&&!R.value,"for-mat-data":j.value.forMatData,onSelectionChange:a[1]||(a[1]=e=>j.value.selectionChange(e,j.value,(0,o.SU)(E).$refs.table)),onRefresh:a[2]||(a[2]=e=>j.value.initData(j.value,(0,o.SU)(E).$refs.table)),onCurrentChange:a[3]||(a[3]=e=>j.value.currentPageChange(e,j.value,(0,o.SU)(E).$refs.table)),onSizeChange:a[4]||(a[4]=e=>j.value.pageSizeChange(e,j.value,(0,o.SU)(E).$refs.table))},{endOption:(0,t.w5)((({row:e})=>[(0,t._)("div",null,[(0,t.Wm)(I,{rowdata:e},null,8,["rowdata"])])])),_:1},8,["total","current-page","page-size","table-data","table-header","loading","for-mat-data"])]),le.isShow?((0,t.wg)(),(0,t.j4)(d.Z,{key:0,ref:"dialogSearch","use-choose":!1,"append-table-style":{background:"#126f9e",color:"#fff",borderColor:"rgba(192, 192, 192,.5)"},width:"60%","search-input-placeholder":le.searchPlaceholde,"is-show":le.isShow,"data-source":le.dataSource,title:"选择数据","is-show-search-input":"",loading:(0,o.SU)(s.V),onCloseDialog:a[5]||(a[5]=e=>le.isShow=!1),onDoDialogSearch:le.doSearch,onChooseRow:le.chooseRow},null,8,["append-table-style","search-input-placeholder","is-show","data-source","loading","onDoDialogSearch","onChooseRow"])):(0,t.kq)("",!0),(0,t.Wm)(O,{modelValue:R.value,"onUpdate:modelValue":a[8]||(a[8]=e=>R.value=e),"lock-scroll":"",title:"账单字段更新日志","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1,top:"4%",width:"70%","destroy-on-close":""},{header:(0,t.w5)((({titleId:e,titleClass:l})=>[(0,t._)("div",v,[(0,t._)("div",{id:e,class:(0,i.C_)(l)},f,10,w),(0,t._)("div",null,[(0,t.Wm)((0,o.SU)(u.ElButton),{class:"dialog-close-btn",type:"danger",icon:"CloseBold",circle:"",onClick:a[6]||(a[6]=e=>{R.value=!1,B.value=""})})])])])),default:(0,t.w5)((()=>[(0,t._)("div",null,[(0,t.Wm)(W,{modelValue:B.value,"onUpdate:modelValue":a[7]||(a[7]=e=>B.value=e),placeholder:"请选择要查看的字段",style:{width:"240px"},filterable:"",onChange:Z},{default:(0,t.w5)((()=>[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(q,(e=>((0,t.wg)(),(0,t.j4)(K,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),S,(0,t._)("div",k,[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(Y,((e,a)=>((0,t.wg)(),(0,t.iD)("div",{key:a,class:"mt10 mb10 pb10",style:{"border-bottom":"1px dashed #ccc"}},[(0,t._)("span",{class:"table-label",title:e.originValue},(0,i.zw)(e.originValue),9,C),(0,t._)("span",{class:"table-label",title:e.afterValue},(0,i.zw)(e.afterValue),9,D),(0,t._)("span",x,(0,i.zw)(e.updateTime),1),(0,t._)("span",_,(0,i.zw)(e.updateUser),1)])))),128))])])])),_:1},8,["modelValue"]),(0,t.Wm)(O,{modelValue:F.value,"onUpdate:modelValue":a[9]||(a[9]=e=>F.value=e),"lock-scroll":"",title:"账单字段更新日志","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1,top:"4%",width:"90%","destroy-on-close":""},{header:(0,t.w5)((({titleId:e,titleClass:a})=>[(0,t._)("div",U,[(0,t._)("div",{id:e,class:(0,i.C_)(a)},H,10,T)])])),default:(0,t.w5)((()=>[(0,t._)("div",null,[(0,t.Wm)(Q,{data:(0,o.SU)(L),style:{width:"100%"}},{default:(0,t.w5)((()=>[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(j.value.tableHeader,(e=>((0,t.wg)(),(0,t.j4)(A,{key:e.key,label:e.title,width:e.width},{default:(0,t.w5)((a=>[(0,t._)("div",$,[(0,t.Wm)(N,{modelValue:a.row[e.key],"onUpdate:modelValue":l=>a.row[e.key]=l,size:"small"},null,8,["modelValue","onUpdate:modelValue"])])])),_:2},1032,["label","width"])))),128))])),_:1},8,["data"])]),(0,t._)("div",V,[(0,t.Wm)((0,o.SU)(u.ElButton),{type:"primary",style:{float:"right","margin-right":"10px"},onClick:M},{default:(0,t.w5)((()=>[(0,t.Uk)(" 确定修改 ")])),_:1})])])),_:1},8,["modelValue"])])}}};var B=(0,l(40089).Z)(a,[["__scopeId","data-v-d851f518"]])}}]);